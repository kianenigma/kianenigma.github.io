<aside class="floating-control">
    <span class="theme-switch">
        <i class="svg-icon light" icon-name="sun" aria-hidden="true"></i>
        <i class="svg-icon dark" icon-name="moon" aria-hidden="true"></i>
    </span>
</aside>

<script>
    (function() {
        // Only initialize once, even if component is included multiple times
        if (window.themeScriptLoaded) return;
        window.themeScriptLoaded = true;

        function setThemeIcon(themeSwitchElement, theme) {
            let toRemove;
            switch (theme) {
                case 'dark':
                    toRemove = ['light'];
                    break;
                case 'light':
                    toRemove = ['dark'];
                    break;
            }
            themeSwitchElement.classList.add(theme);
            themeSwitchElement.classList.remove(...toRemove);
        }

        function setTheme(theme) {
            // Update all theme switch elements
            const themeSwitches = document.querySelectorAll('.theme-switch');
            themeSwitches.forEach(switchEl => {
                setThemeIcon(switchEl, theme);
            });

            // Update body theme
            if (theme == 'dark') {
                document.body.classList.remove('theme-light');
                document.body.classList.add('theme-dark');
            } else {
                document.body.classList.add('theme-light');
                document.body.classList.remove('theme-dark');
            }
        }

        function initializeTheme() {
            // Initialize theme
            let currentTheme = window.localStorage.getItem('site-theme') || "dark";
            if (currentTheme == "auto") {
                currentTheme = "dark";
            }
            setTheme(currentTheme);
            window.theme = currentTheme;
            window.localStorage.setItem('site-theme', currentTheme);

            // Add click handlers to all theme switches
            const themeSwitches = document.querySelectorAll('.theme-switch');
            themeSwitches.forEach(switchEl => {
                // Remove existing listeners by cloning
                const newSwitch = switchEl.cloneNode(true);
                switchEl.parentNode.replaceChild(newSwitch, switchEl);

                newSwitch.addEventListener('click', function() {
                    const newTheme = (window.theme === 'dark') ? 'light' : 'dark';
                    setTheme(newTheme);
                    window.localStorage.setItem('site-theme', newTheme);
                    window.theme = newTheme;
                });
            });
        }

        // Run when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeTheme);
        } else {
            initializeTheme();
        }
    })();
</script>
